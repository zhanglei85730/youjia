/*! natty-fetch.min.js v2.4.5 | MIT License | fushan | https://github.com/jias/natty-fetch */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("natty-storage")):"function"==typeof define&&define.amd?define(["natty-storage"],e):t.nattyFetch=e(t.nattyStorage)}(this,function(t){"use strict";function e(t){return t}function n(t){return function(){for(var e=arguments,n=t(e[0],e[1]),r=2,o=e.length;r<o;r++)n=t(n,e[r]);return n}}function r(){return J(9e9*H())}function o(t){return!!t.match(B)}function i(t){return!!t.match(D)}function a(t){return typeof t===V}function s(t){return typeof t===z}function c(t){return typeof t===K}function u(t){return c(t)?t():t}function l(t){return!isNaN(t)&&typeof t===Q}function p(t){return typeof t===Y&&t!==R}function f(t){return t!==R&&t===t.window}function d(t){return t!==R&&p(t)&&!f(t)&&Object.getPrototypeOf(t)===Object.prototype}function h(t){var e=0;for(var n in t)t.hasOwnProperty(n)&&e++;return 0===e}function g(t){return I.call(t)===M}function m(t){var e=N.createElement("a");return e.href=t,G.hostname!==e.hostname||G.port!==e.port||G.protocol!==e.protocol}function v(t,e,n){void 0===t&&(t={}),void 0===e&&(e={}),void 0===n&&(n=U);for(var r in e)e.hasOwnProperty(r)&&void 0!==e[r]&&(n===L?g(e[r])?t[r]=[].concat(e[r]):d(e[r])?t[r]=$({},e[r]):t[r]=e[r]:t[r]=e[r]);return t}function y(t){return!!t&&typeof t.length===Q}function b(t,e){var n,r;if(y(t)){for(n=0,r=t.length;n<r;n++)if(e.call(t[n],t[n],n)===!1)return}else for(n in t)if(e.call(t[n],t[n],n)===!1)return}function j(t){var e,n={},r=[];for(e in t)t.hasOwnProperty(e)&&(r.push(e),d(t[e])&&(t[e]=j(t[e])));r.sort();for(var o=0,i=r.length;o<i;o++)n[r[o]]=t[r[o]];return n}function k(t,e,n,r){var o,i=g(e),a=d(e);b(e,function(e,s){o=I.call(e),r&&(s=n?r:r+"["+(a||o==A||o==M?s:"")+"]"),!r&&i?t.add(e.name,e.value):o==M||!n&&o==A?k(t,e,n,s):t.add(s,e)})}function _(t,e){var n=[];return n.add=function(t,e){c(e)&&(e=e()),e==R&&(e=""),n.push(P(t)+"="+P(e))},k(n,t,e),n.join("&").replace(/%20/g,"+")}function w(t){return decodeURIComponent(t.replace(/\+/g," "))}function x(t,e,n,r){n&&(e[a(n)?"_stamp":n]=+new Date);var o=_(e,r);return o?t+(~t.indexOf("?")?"&":"?")+o:t}function S(t){t=$({},ct,t);var e=m(t.url),n=new XMLHttpRequest;st(n,t),n.open(t.method,x(t.url,$({},t.useMark?t.mark:{},t.method===et?t.data:{}),t.urlStamp,t.traditional)),n.withCredentials=a(t.withCredentials)?t.withCredentials:e;var r,o=at(n,t);r=o["Content-Type"]&&~o["Content-Type"].indexOf("application/x-www-form-urlencoded")?_(t.data,t.traditional):JSON.stringify(t.data),n.send(t.method===et?R:r===R?R:r);var i=n.abort;return n.abort=function(){n._aborted=!0,i.call(n)},n}function O(t){t=$({},gt,t);var e,n=t.callbackName=t.callbackName.replace(/\{id\}/,r()),o=t.complete;t.complete=function(){ft(e),o()},ut[n]=function(e){ut[n]=R,t.success(e),t.complete()};var i,a=x(t.url,$((i={},i[t.flag]=n,i),t.useMark?t.mark:{},t.data),t.urlStamp,t.traditional);return e=ht(a,t),{abort:function(){ut[n]=function(){ut[n]=R},ft(e)}}}function C(t){return jt+t}t="default"in t?t.default:t;var E="undefined"!=typeof window,q="undefined"!=typeof console,N=E?document:null,P=encodeURIComponent,R=null,L=!0,U=!L,T="undefined",F="",I=Object.prototype.toString,M="[object Array]",A="[object Object]",X={dummy:L};X.then=X.catch=function(){return X};var G,W=E&&(!!window.ActiveXObject||"ActiveXObject"in window),H=Math.random,J=Math.floor,B=/^(https?:)?\/\//,D=/^[\.\/]/,V="boolean",z="string",K="function",Q="number",Y="object";N&&(G=N.createElement("a"),G.href=location.href);var $=n(v),Z=Object.freeze({hasWindow:E,hasConsole:q,doc:N,escape:P,NULL:R,TRUE:L,FALSE:U,UNDEFINED:T,EMPTY:F,dummyPromise:X,isIE:W,noop:e,redo:n,makeRandom:r,isAbsoluteUrl:o,isRelativeUrl:i,isBoolean:a,isString:s,isFunction:c,runAsFn:u,isNumber:l,isObject:p,isWindow:f,isPlainObject:d,isEmptyObject:h,isArray:g,isCrossDomain:m,extend:$,likeArray:y,each:b,sortPlainObjectKey:j,serialize:k,param:_,decodeParam:w,appendQueryString:x}),tt=T!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,et="GET",nt="script",rt="xml",ot="json",it={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},at=function(t,e){var n={Accept:it[e.accept]};m(e.url)||(n["X-Requested-With"]="XMLHttpRequest"),"POST"!==e.method||n["Content-Type"]||(n["Content-Type"]="application/x-www-form-urlencoded"),$(n,e.header);for(var r in n)t.setRequestHeader(r,n[r]);return n},st=function(t,e){t._finished=U;var n=function(){if(!t._finished&&4===t.readyState)if(t.status>=200&&t.status<300||304===t.status){var n=t.responseText;switch(e.accept){case ot:try{n=JSON.parse(n)}catch(t){console.warn("The response can NOT be parsed to JSON object.",n)}break;case nt:(0,eval)(n);break;case rt:n=t.responseXML}e.success(n,t)}else!t._aborted&&e.error(t.status,t)};t.addEventListener("readystatechange",n);var r=function(){t._finished||e.abort(t.status,t)};t.addEventListener("abort",r);var o=function(){t._finished||(t._finished=!0,e.complete(t.status,t),delete t._aborted)};t.addEventListener("loadend",o)},ct={url:"",mark:{},useMark:L,method:et,accept:"*",data:R,header:{},withCredentials:R,urlStamp:L,success:e,error:e,complete:e,abort:e,log:U,traditional:U};S.fallback=!1,S.supportCORS=tt;var ut=E?window:R,lt=E?document:R,pt="script",ft=function(t){t.onerror=R,t.parentNode.removeChild(t),t=R},dt=R,ht=function(t,e){var n=lt.createElement(pt);return n.src=t,n.async=!0,e.crossOrigin&&(n.crossOrigin=!0),n.onerror=function(t){ut[e.callbackName]=R,e.error(t),e.complete()},dt=dt||lt.getElementsByTagName("head")[0],dt.insertBefore(n,dt.firstChild),n},gt={url:"",mark:{},useMark:L,data:{},urlStamp:L,success:e,error:e,complete:e,log:U,flag:"callback",callbackName:"jsonp{id}",traditional:U,crossOrigin:U},mt=0,vt=function(){return mt++},yt=function(t){var e=t._path,n=t.config,r=t.api,o=t.contextId;this._apiInstance=t,this._rid=[o,e,vt()].join("-"),this._path=e,this.config=n,this.storage=r.storage,this.contextId=o,this.pending=U,this._requester=R};yt.prototype.send=function(t){var e=this,n=t.vars,r=t.onSuccess,o=t.onError,i=t.onComplete;this.vars=n,this.onSuccess=r,this.onError=o,this.onComplete=i;var a=this,s=a.config;s.willFetch(n,s,"remote"),this.pending=L,s.customRequest?this._requester=s.customRequest(n,s,function(t,n){t?e.processResponse(n):e.onError(n)}):s.jsonp?this._requester=this.jsonp():this._requester=this.ajax(),0!==s.timeout&&setTimeout(function(){if(e.pending){e.abort();var t={timeout:L,message:"Timeout By "+s.timeout+"ms."};e.onError(t)}},s.timeout)},yt.prototype.processResponse=function(t){var e=this,n=e.config,r=e.vars;if(n.didFetch(r,n),t=n.fit(t,r),t.success){var o=n.process(t.content,r);this.onSuccess(o)}else{var i=$({message:"`success` is false, "+this._path},t.error);this.onError(i)}},yt.prototype.getFinalUrl=function(){var t=this,e=t.config,n=t.vars,r=e.mock?e.mockUrl:e.url;if(!r)return F;var a=e.mock?"mockUrlPrefix":"urlPrefix",s=e.mock?"mockUrlSuffix":"urlSuffix",c=!e[a]||o(r)||i(r)?F:e[a],u=e[s]?e[s]:F;if(r=c+r+u,e.rest){var l=n.data;for(var p in l)~p.indexOf(":")&&(r=r.replace(new RegExp("\\/"+p),"/"+l[p]),delete l[p])}return r},yt.prototype.ajax=function(){var t=this,e=this,n=e.config,r=e.vars,o=this.getFinalUrl();return S({traditional:n.traditional,urlStamp:n.urlStamp,mark:r.mark,useMark:n.mark,log:n.log,url:o,method:n.method,data:r.data,header:n.header,withCredentials:n.withCredentials,accept:"json",success:function(e){t.processResponse(e)},error:function(e){var n={status:e,message:"Error(status "+e+") in request for "+r.mark._api+"("+o+")"};t.onError(n)},complete:function(){t.onComplete(),t.pending=U,t._requester=R}})},yt.prototype.jsonp=function(){var t=this,e=this,n=e.config,r=e.vars,o=this.getFinalUrl();return O({traditional:n.traditional,log:n.log,mark:r.mark,useMark:n.mark,url:o,data:r.data,urlStamp:n.urlStamp,flag:n.jsonpFlag,callbackName:n.jsonpCallbackName,crossOrigin:n.jsonpCrossOrigin,success:function(e){t.processResponse(e)},error:function(){var e={message:"Not accessable JSONP in request for "+r.mark._api+"("+o+")"};t.onError(e)},complete:function(){t.onComplete(),t.pending=U,t._requester=R}})},yt.prototype.abort=function(){this._requester&&this._requester.abort()};var bt=function(t){var e=this;e.promise=new t(function(t,n){e._resolve=t,e._reject=n})};bt.prototype.resolve=function(t){this._resolve.call(this.promise,t)},bt.prototype.reject=function(t){this._reject.call(this.promise,t)};var jt="_",kt={on:function(){var t=this,e=arguments;if("string"==typeof e[0]&&"function"==typeof e[1]){var n=C(e[0]);this[n]=this[n]||[],this[n].push(e[1])}else if("object"==typeof e[0]){var r=e[0];for(var o in r)t.on(o,r[o])}},off:function(t,e){if(t=C(t),e){var n=this[t];n.splice(n.indexOf(e),1),this[t].length||delete this[t]}else delete this[t]},fire:function(t,e,n){var r=this,o=this[C(t)];if(!o)return"NO_EVENT";for(var i=0,a=void 0;a=o[i];i++)a.apply(n||r,[].concat(e))},hasEvent:function(t){return!!this[C(t)]}},_t=function(){var t=this,n=t.api;n.loop=function(t,r,o){if(void 0===r&&(r=e),void 0===o&&(o=e),!t.duration||!l(t.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var i=R,a=function(){clearTimeout(i),i=R,a.looping=U},s=function(){a.looping=L,n(t.data).then(r,o),i=setTimeout(function(){s()},t.duration)};return s(),a}},wt=function(){var t=this,n=this,r=n.api;r.soon=function(n,o,i){void 0===o&&(o=e),void 0===i&&(i=e);var a=t.makeVars(n);if(r.storageUseable){var s=r.storage.has(a.queryString);s.has&&o({fromStorage:L,content:s.value})}t.send(a).then(function(t){o({fromStorage:U,content:t})},function(t){i(t)}).catch(function(t){q&&console.error(t)})}},xt={data:{},didFetch:e,fit:e,header:{},ignoreSelfConcurrent:U,jsonp:U,jsonpCrossOrigin:U,log:U,method:"GET",mock:U,mockUrl:F,mockUrlPrefix:F,mockUrlSuffix:F,process:e,Promise:E?window.Promise:R,rest:U,retry:0,customRequest:R,timeout:0,traditional:U,url:F,urlPrefix:F,urlStamp:L,urlSuffix:F,withCredentials:R,willFetch:e,storage:U,plugins:U},St=$,Ot=u,Ct=a,Et=g,qt=c,Nt=j,Pt=h,Rt=d,Lt=X,Ut=s,Tt=R,Ft=L,It=U,Mt=q,At=St({},xt),Xt=function(t,e,n,r){var o=this;this._path=t,this.contextConfig=n,this.contextId=r,this._pendingList=[],this.storage=Tt;var i=this.config=this.processAPIOptions(e);this.api=function(t){if(o._pendingList.length){if(i.ignoreSelfConcurrent)return Lt;i.overrideSelfConcurrent&&o._pendingList[0].abort()}var e=o.makeVars(t);if(o.api.storageUseable){var n=o.api.storage.has(e.queryString);return n.has?new i.Promise(function(t){t(n.value)}):0===i.retry?o.send(e):o.sendWithRetry(e)}return 0===i.retry?o.send(e):o.sendWithRetry(e)},this.api.config=i,this.api.hasPending=function(){return!!o._pendingList.length},this.api.abort=function(){Mt&&console.warn("`abort` method will be deleted later!");for(var t=0,e=o._pendingList.length;t<e;t++)o._pendingList[t].abort()},this.initStorage();for(var a=Et(i.plugins)?i.plugins:[],s=0,c=a.length;s<c;s++)qt(a[s])&&a[s].call(o,o)};Xt.prototype.makeVars=function(t){var e=this,n=e.config,r={mark:{_api:this._path,_mock:n.mock}};return t=St({},Ot(n.data),Ot(t)),r.data=t,this.api.storageUseable&&(r.queryString=Pt(t)?"no-query-string":JSON.stringify(Nt(t))),r},Xt.prototype.send=function(t){var e=this,n=this,r=n.config,o=new yt(this);this._pendingList.push(o);var i=new bt(r.Promise);return o.send({vars:t,onSuccess:function(n){e.api.storageUseable&&e.api.storage.set(t.queryString,n),i.resolve(n),kt.fire("g.resolve",[n,r],r),kt.fire(e.contextId+".resolve",[n,r],r)},onError:function(n){i.reject(n),kt.fire("g.reject",[n,r,t],r),kt.fire(e.contextId+".reject",[n,r,t],r)},onComplete:function(){for(var t,n=0,r=e._pendingList.length;n<r;n++)if(e._pendingList[n]===o){t=n;break}void 0!==t&&e._pendingList.splice(t,1)}}),i.promise},Xt.prototype.sendWithRetry=function(t){var e=this,n=this,r=n.config;return new r.Promise(function(n,o){var i=0,a=function(){t.mark._retryTime=i,e.send(t).then(function(t){n(t)},function(t){i===r.retry?o(t):(i++,a())})};a()})},Xt.prototype.processAPIOptions=function(t){var e=[].concat(this.contextConfig.plugins||[],t.plugins||[]),n=St({},this.contextConfig,t,{plugins:e});return Et(t.jsonp)&&(n.jsonp=Ct(t.jsonp[0])?t.jsonp[0]:It,n.jsonp&&(n.jsonpFlag=t.jsonp[1],n.jsonpCallbackName=t.jsonp[2])),!n.mock&&n.url.match(/\.jsonp(\?.*)?$/)&&(n.jsonp=Ft),n},Xt.prototype.initStorage=function(){var e=this,n=e.config;if(n.storage===Ft&&(n.storage={type:"variable"}),this.api.storageUseable=Rt(n.storage)&&("GET"===n.method||n.jsonp)&&t.supportStorage&&(["localStorage","sessionStorage"].indexOf(n.storage.type)>-1||"variable"===n.storage.type),this.api.storageUseable){if("localStorage"===n.storage.type){if(!n.storage.hasOwnProperty("key")||!n.storage.key)throw new Error("`key` is required when `storage.type` is `localStorage`.")}else n.storage.key=n.storage.key||[this.contextId,this._path].join("_");this.api.storage=t(St({},n.storage,{tag:[n.storage.tag,n.jsonp?"jsonp":n.method,n.url].join("_")}))}};var Gt=function(){var e=0;return function(n,r){Ut(n)?r=r||{}:(r=n||{},n="c"+e++);var o=t({type:"variable",key:n}),i={};i.api=o.get(),i._contextId=n;var a=[].concat(At.plugins||[],r.plugins||[]);return i._config=St({},At,r,{plugins:a}),i.create=function(t,e){var r=2===arguments.length&&Ut(t);r||(e=t);for(var a in e)o.set(r?t+"."+a:a,new Xt(r?t+"."+a:a,Ot(e[a]),i._config,n).api);i.api=o.get()},i.on=function(t,e){if(qt(e))return kt.on(i._contextId+"."+t,e),i},i}}(),Wt={};return Wt.create=function(t){return new Xt("nattyFetch",Ot(t),xt,"global").api},St(Wt,{onlyForModern:!0,version:"2.4.5",_util:Z,_event:kt,_ajax:S,context:Gt,setGlobal:function(t){return At=St({},xt,t),this},getGlobal:function(t){return t?At[t]:At},on:function(t,e){if(qt(e))return kt.on("g."+t,e),this},plugin:{loop:_t,soon:wt}}),Wt.setGlobal(xt),Wt});
//# sourceMappingURL=natty-fetch.min.js.map

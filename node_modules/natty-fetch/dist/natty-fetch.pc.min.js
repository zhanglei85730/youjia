/*! natty-fetch.pc.min.js v2.4.5 | MIT License | fushan | https://github.com/jias/natty-fetch */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("natty-storage")):"function"==typeof define&&define.amd?define(["natty-storage"],e):t.nattyFetch=e(t.nattyStorage)}(this,function(t){"use strict";function e(t){return t}function r(t){return function(){for(var e=arguments,r=t(e[0],e[1]),n=2,o=e.length;n<o;n++)r=t(r,e[n]);return r}}function n(){return W(9e9*H())}function o(t){return!!t.match(J)}function i(t){return!!t.match(B)}function a(t){return typeof t===V}function s(t){return typeof t===z}function c(t){return typeof t===K}function u(t){return c(t)?t():t}function l(t){return!isNaN(t)&&typeof t===Q}function p(t){return typeof t===Y&&t!==P}function f(t){return t!==P&&t===t.window}function d(t){return t!==P&&p(t)&&!f(t)&&Object.getPrototypeOf(t)===Object.prototype}function h(t){var e=0;for(var r in t)t.hasOwnProperty(r)&&e++;return 0===e}function m(t){return F.call(t)===M}function g(t){var e=N.createElement("a");return e.href=t,!G||":"!==e.protocol&&""!==e.protocol?D.hostname!==e.hostname||D.port!==e.port||D.protocol!==e.protocol:""!==e.hostname&&(D.hostname!==e.hostname||D.port!==e.port)}function v(t,e,r){void 0===t&&(t={}),void 0===e&&(e={}),void 0===r&&(r=T);for(var n in e)e.hasOwnProperty(n)&&void 0!==e[n]&&(r===U?m(e[n])?t[n]=[].concat(e[n]):d(e[n])?t[n]=$({},e[n]):t[n]=e[n]:t[n]=e[n]);return t}function y(t){return!!t&&typeof t.length===Q}function b(t,e){var r,n;if(y(t)){for(r=0,n=t.length;r<n;r++)if(e.call(t[r],t[r],r)===!1)return}else for(r in t)if(e.call(t[r],t[r],r)===!1)return}function j(t){var e,r={},n=[];for(e in t)t.hasOwnProperty(e)&&(n.push(e),d(t[e])&&(t[e]=j(t[e])));n.sort();for(var o=0,i=n.length;o<i;o++)r[n[o]]=t[n[o]];return r}function _(t,e,r,n){var o,i=m(e),a=d(e);b(e,function(e,s){o=F.call(e),n&&(s=r?n:n+"["+(a||o==A||o==M?s:"")+"]"),!n&&i?t.add(e.name,e.value):o==M||!r&&o==A?_(t,e,r,s):t.add(s,e)})}function k(t,e){var r=[];return r.add=function(t,e){c(e)&&(e=e()),e==P&&(e=""),r.push(R(t)+"="+R(e))},_(r,t,e),r.join("&").replace(/%20/g,"+")}function w(t){return decodeURIComponent(t.replace(/\+/g," "))}function S(t,e,r,n){r&&(e[a(r)?"_stamp":r]=+new Date);var o=k(e,n);return o?t+(~t.indexOf("?")?"&":"?")+o:t}function x(t){t=$({},pt,t);var e=g(t.url),r=new XMLHttpRequest;at&&e&&(r=new XDomainRequest),r._completed=T,lt(r,t,e),r.open(t.method,S(t.url,$({},t.useMark?t.mark:{},t.method===tt?t.data:{}),t.urlStamp,t.traditional)),at||(r.withCredentials=a(t.withCredentials)?t.withCredentials:e);var n,o=ut(r,t);return n=o["Content-Type"]&&~o["Content-Type"].indexOf("application/x-www-form-urlencoded")?k(t.data,t.traditional):JSON.stringify(t.data),r.send(t.method===tt?P:n===P?P:n),r}function O(t){t=$({},bt,t);var e,r=t.callbackName=t.callbackName.replace(/\{id\}/,n()),o=t.complete;t.complete=function(){gt(e),o()},ft[r]=function(e){ft[r]=P,t.success(e),t.complete()};var i,a=S(t.url,$((i={},i[t.flag]=r,i),t.useMark?t.mark:{},t.data),t.urlStamp,t.traditional);return e=yt(a,t),{abort:function(){ft[r]=function(){ft[r]=P},gt(e)}}}function C(t){return St+t}t="default"in t?t["default"]:t;var E="undefined"!=typeof window,q="undefined"!=typeof console,N=E?document:null,R=encodeURIComponent,P=null,U=!0,T=!U,L="undefined",I="",F=Object.prototype.toString,M="[object Array]",A="[object Object]",X={dummy:U};X.then=X["catch"]=function(){return X};var D,G=E&&(!!window.ActiveXObject||"ActiveXObject"in window),H=Math.random,W=Math.floor,J=/^(https?:)?\/\//,B=/^[\.\/]/,V="boolean",z="string",K="function",Q="number",Y="object";N&&(D=N.createElement("a"),D.href=location.href);var $=r(v),Z=Object.freeze({hasWindow:E,hasConsole:q,doc:N,escape:R,NULL:P,TRUE:U,FALSE:T,UNDEFINED:L,EMPTY:I,dummyPromise:X,isIE:G,noop:e,redo:r,makeRandom:n,isAbsoluteUrl:o,isRelativeUrl:i,isBoolean:a,isString:s,isFunction:c,runAsFn:u,isNumber:l,isObject:p,isWindow:f,isPlainObject:d,isEmptyObject:h,isArray:m,isCrossDomain:g,extend:$,likeArray:y,each:b,sortPlainObjectKey:j,serialize:_,param:k,decodeParam:w,appendQueryString:S}),tt="GET",et="script",rt="xml",nt="json",ot=L!==typeof XMLHttpRequest?new XMLHttpRequest:{},it=L!==typeof XDomainRequest,at=E?!("withCredentials"in ot)&&it:P,st=E?"withCredentials"in ot||it:P,ct={"*":"*/*",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript",json:"application/json, text/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},ut=function(t,e){if(!t.setRequestHeader)return{};var r={Accept:ct[e.accept]};g(e.url)||(r["X-Requested-With"]="XMLHttpRequest"),"POST"!==e.method||r["Content-Type"]||(r["Content-Type"]="application/x-www-form-urlencoded"),$(r,e.header);for(var n in r)t.setRequestHeader(n,r[n]);return r},lt=function(t,r,n){var o=function(){t._completed||(t._completed=!0,r.complete(),t._aborted=null,delete t._aborted)},i=function(){if(!t._completed){var e=t.responseText;switch(r.accept){case nt:try{e=JSON.parse(e)}catch(t){console.warn("The response can NOT be parsed to JSON object.",e)}break;case et:(0,eval)(e);break;case rt:e=t.responseXML}r.success(e,t),o()}},a=function(){t._completed||(r.error(t.status,t),o())},s=function(){t._completed||(r.abort(),o())};at&&n?t.onload=i:t.onreadystatechange=function(){t._completed||4==t.readyState&&(t.status>=200&&t.status<300||304===t.status?i():!t._aborted&&a())},t.onerror=a;var c=t.abort;t.abort=function(){t._completed||(t._aborted=!0,G||c.call(t),s())},t.onprogress=t.ontimeout=e},pt={url:"",mark:{},useMark:U,method:tt,accept:"*",data:P,header:{},withCredentials:P,urlStamp:U,success:e,error:e,complete:e,abort:e,log:T,traditional:T};x.fallback=at,x.supportCORS=st;var ft=E?window:P,dt=E?document:P,ht="script",mt=E?navigator.userAgent.indexOf("MSIE 8.0")>-1:T,gt=function(t){mt&&t.readyState?t.onreadystatechange=P:t.onerror=P,t.parentNode.removeChild(t),t=P},vt=P,yt=function(t,e){var r=dt.createElement(ht);return r.type="text/javascript",r.src=t,r.async=U,e.crossOrigin&&(r.crossorigin=!0),mt&&r.readyState?r.onreadystatechange=function(){"loaded"===r.readyState&&ft[e.callbackName]&&(ft[e.callbackName]=P,e.error(),e.complete())}:r.onerror=function(t){ft[e.callbackName]=P,e.error(t),e.complete()},vt=vt||dt.getElementsByTagName("head")[0],vt.insertBefore(r,vt.firstChild),r},bt={url:"",mark:{},useMark:U,data:{},urlStamp:U,success:e,error:e,complete:e,log:T,flag:"callback",callbackName:"jsonp{id}",traditional:T,crossOrigin:T},jt=0,_t=function(){return jt++},kt=function(t){var e=t._path,r=t.config,n=t.api,o=t.contextId;this._apiInstance=t,this._rid=[o,e,_t()].join("-"),this._path=e,this.config=r,this.storage=n.storage,this.contextId=o,this.pending=T,this._requester=P};kt.prototype.send=function(t){var e=this,r=t.vars,n=t.onSuccess,o=t.onError,i=t.onComplete;this.vars=r,this.onSuccess=n,this.onError=o,this.onComplete=i;var a=this,s=a.config;s.willFetch(r,s,"remote"),this.pending=U,s.customRequest?this._requester=s.customRequest(r,s,function(t,r){t?e.processResponse(r):e.onError(r)}):s.jsonp?this._requester=this.jsonp():this._requester=this.ajax(),0!==s.timeout&&setTimeout(function(){if(e.pending){e.abort();var t={timeout:U,message:"Timeout By "+s.timeout+"ms."};e.onError(t)}},s.timeout)},kt.prototype.processResponse=function(t){var e=this,r=e.config,n=e.vars;if(r.didFetch(n,r),t=r.fit(t,n),t.success){var o=r.process(t.content,n);this.onSuccess(o)}else{var i=$({message:"`success` is false, "+this._path},t.error);this.onError(i)}},kt.prototype.getFinalUrl=function(){var t=this,e=t.config,r=t.vars,n=e.mock?e.mockUrl:e.url;if(!n)return I;var a=e.mock?"mockUrlPrefix":"urlPrefix",s=e.mock?"mockUrlSuffix":"urlSuffix",c=!e[a]||o(n)||i(n)?I:e[a],u=e[s]?e[s]:I;if(n=c+n+u,e.rest){var l=r.data;for(var p in l)~p.indexOf(":")&&(n=n.replace(new RegExp("\\/"+p),"/"+l[p]),delete l[p])}return n},kt.prototype.ajax=function(){var t=this,e=this,r=e.config,n=e.vars,o=this.getFinalUrl();return x({traditional:r.traditional,urlStamp:r.urlStamp,mark:n.mark,useMark:r.mark,log:r.log,url:o,method:r.method,data:n.data,header:r.header,withCredentials:r.withCredentials,accept:"json",success:function(e){t.processResponse(e)},error:function(e){var r={status:e,message:"Error(status "+e+") in request for "+n.mark._api+"("+o+")"};t.onError(r)},complete:function(){t.onComplete(),t.pending=T,t._requester=P}})},kt.prototype.jsonp=function(){var t=this,e=this,r=e.config,n=e.vars,o=this.getFinalUrl();return O({traditional:r.traditional,log:r.log,mark:n.mark,useMark:r.mark,url:o,data:n.data,urlStamp:r.urlStamp,flag:r.jsonpFlag,callbackName:r.jsonpCallbackName,crossOrigin:r.jsonpCrossOrigin,success:function(e){t.processResponse(e)},error:function(){var e={message:"Not accessable JSONP in request for "+n.mark._api+"("+o+")"};t.onError(e)},complete:function(){t.onComplete(),t.pending=T,t._requester=P}})},kt.prototype.abort=function(){this._requester&&this._requester.abort()};var wt=function(t){var e=this;e.promise=new t(function(t,r){e._resolve=t,e._reject=r})};wt.prototype.resolve=function(t){this._resolve.call(this.promise,t)},wt.prototype.reject=function(t){this._reject.call(this.promise,t)};var St="_",xt={on:function(){var t=this,e=arguments;if("string"==typeof e[0]&&"function"==typeof e[1]){var r=C(e[0]);this[r]=this[r]||[],this[r].push(e[1])}else if("object"==typeof e[0]){var n=e[0];for(var o in n)t.on(o,n[o])}},off:function(t,e){if(t=C(t),e){var r=this[t];r.splice(r.indexOf(e),1),this[t].length||delete this[t]}else delete this[t]},fire:function(t,e,r){var n=this,o=this[C(t)];if(!o)return"NO_EVENT";for(var i=0,a=void 0;a=o[i];i++)a.apply(r||n,[].concat(e))},hasEvent:function(t){return!!this[C(t)]}},Ot=function(){var t=this,r=t.api;r.loop=function(t,n,o){if(void 0===n&&(n=e),void 0===o&&(o=e),!t.duration||!l(t.duration))throw new Error("Illegal `duration` value for `startLoop` method.");var i=P,a=function(){clearTimeout(i),i=P,a.looping=T},s=function(){a.looping=U,r(t.data).then(n,o),i=setTimeout(function(){s()},t.duration)};return s(),a}},Ct=function(){var t=this,r=this,n=r.api;n.soon=function(r,o,i){void 0===o&&(o=e),void 0===i&&(i=e);var a=t.makeVars(r);if(n.storageUseable){var s=n.storage.has(a.queryString);s.has&&o({fromStorage:U,content:s.value})}t.send(a).then(function(t){o({fromStorage:T,content:t})},function(t){i(t)})["catch"](function(t){q&&console.error(t)})}},Et={data:{},didFetch:e,fit:e,header:{},ignoreSelfConcurrent:T,jsonp:T,jsonpCrossOrigin:T,log:T,method:"GET",mock:T,mockUrl:I,mockUrlPrefix:I,mockUrlSuffix:I,process:e,Promise:E?window.Promise:P,rest:T,retry:0,customRequest:P,timeout:0,traditional:T,url:I,urlPrefix:I,urlStamp:U,urlSuffix:I,withCredentials:P,willFetch:e,storage:T,plugins:T},qt=$,Nt=u,Rt=a,Pt=m,Ut=c,Tt=j,Lt=h,It=d,Ft=X,Mt=s,At=P,Xt=U,Dt=T,Gt=q,Ht=qt({},Et),Wt=function(t,e,r,n){var o=this;this._path=t,this.contextConfig=r,this.contextId=n,this._pendingList=[],this.storage=At;var i=this.config=this.processAPIOptions(e);this.api=function(t){if(o._pendingList.length){if(i.ignoreSelfConcurrent)return Ft;i.overrideSelfConcurrent&&o._pendingList[0].abort()}var e=o.makeVars(t);if(o.api.storageUseable){var r=o.api.storage.has(e.queryString);return r.has?new i.Promise(function(t){t(r.value)}):0===i.retry?o.send(e):o.sendWithRetry(e)}return 0===i.retry?o.send(e):o.sendWithRetry(e)},this.api.config=i,this.api.hasPending=function(){return!!o._pendingList.length},this.api.abort=function(){Gt&&console.warn("`abort` method will be deleted later!");for(var t=0,e=o._pendingList.length;t<e;t++)o._pendingList[t].abort()},this.initStorage();for(var a=Pt(i.plugins)?i.plugins:[],s=0,c=a.length;s<c;s++)Ut(a[s])&&a[s].call(o,o)};Wt.prototype.makeVars=function(t){var e=this,r=e.config,n={mark:{_api:this._path,_mock:r.mock}};return t=qt({},Nt(r.data),Nt(t)),n.data=t,this.api.storageUseable&&(n.queryString=Lt(t)?"no-query-string":JSON.stringify(Tt(t))),n},Wt.prototype.send=function(t){var e=this,r=this,n=r.config,o=new kt(this);this._pendingList.push(o);var i=new wt(n.Promise);return o.send({vars:t,onSuccess:function(r){e.api.storageUseable&&e.api.storage.set(t.queryString,r),i.resolve(r),xt.fire("g.resolve",[r,n],n),xt.fire(e.contextId+".resolve",[r,n],n)},onError:function(r){i.reject(r),xt.fire("g.reject",[r,n,t],n),xt.fire(e.contextId+".reject",[r,n,t],n)},onComplete:function(){for(var t,r=0,n=e._pendingList.length;r<n;r++)if(e._pendingList[r]===o){t=r;break}void 0!==t&&e._pendingList.splice(t,1)}}),i.promise},Wt.prototype.sendWithRetry=function(t){var e=this,r=this,n=r.config;return new n.Promise(function(r,o){var i=0,a=function(){t.mark._retryTime=i,e.send(t).then(function(t){r(t)},function(t){i===n.retry?o(t):(i++,a())})};a()})},Wt.prototype.processAPIOptions=function(t){var e=[].concat(this.contextConfig.plugins||[],t.plugins||[]),r=qt({},this.contextConfig,t,{plugins:e});return Pt(t.jsonp)&&(r.jsonp=Rt(t.jsonp[0])?t.jsonp[0]:Dt,r.jsonp&&(r.jsonpFlag=t.jsonp[1],r.jsonpCallbackName=t.jsonp[2])),!r.mock&&r.url.match(/\.jsonp(\?.*)?$/)&&(r.jsonp=Xt),r},Wt.prototype.initStorage=function(){var e=this,r=e.config;if(r.storage===Xt&&(r.storage={type:"variable"}),this.api.storageUseable=It(r.storage)&&("GET"===r.method||r.jsonp)&&t.supportStorage&&(["localStorage","sessionStorage"].indexOf(r.storage.type)>-1||"variable"===r.storage.type),this.api.storageUseable){if("localStorage"===r.storage.type){if(!r.storage.hasOwnProperty("key")||!r.storage.key)throw new Error("`key` is required when `storage.type` is `localStorage`.")}else r.storage.key=r.storage.key||[this.contextId,this._path].join("_");this.api.storage=t(qt({},r.storage,{tag:[r.storage.tag,r.jsonp?"jsonp":r.method,r.url].join("_")}))}};var Jt=function(){var e=0;return function(r,n){Mt(r)?n=n||{}:(n=r||{},r="c"+e++);var o=t({type:"variable",key:r}),i={};i.api=o.get(),i._contextId=r;var a=[].concat(Ht.plugins||[],n.plugins||[]);return i._config=qt({},Ht,n,{plugins:a}),i.create=function(t,e){var n=2===arguments.length&&Mt(t);n||(e=t);for(var a in e)o.set(n?t+"."+a:a,new Wt(n?t+"."+a:a,Nt(e[a]),i._config,r).api);i.api=o.get()},i.on=function(t,e){if(Ut(e))return xt.on(i._contextId+"."+t,e),i},i}}(),Bt={};return Bt.create=function(t){return new Wt("nattyFetch",Nt(t),Et,"global").api},qt(Bt,{onlyForModern:!1,version:"2.4.5",_util:Z,_event:xt,_ajax:x,context:Jt,setGlobal:function(t){return Ht=qt({},Et,t),this},getGlobal:function(t){return t?Ht[t]:Ht},on:function(t,e){if(Ut(e))return xt.on("g."+t,e),this},plugin:{loop:Ot,soon:Ct}}),Bt.setGlobal(Et),Bt});
//# sourceMappingURL=natty-fetch.pc.min.js.map
